<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>go-based-python-modules</title>

  <link rel="stylesheet" type="text/css"  href="/printfonts/print.css" media="print" />
  <link rel="stylesheet" type="text/css"  href="/webfonts/fonts.css" media="screen" />
  <link rel="stylesheet" type="text/css"  href="/css/site.css" media="screen" />
  <link rel="stylesheet" type="text/css"  href="/css/tables.css" media="screen" />
  <link title="RSS feed for rsdoiel's blog" rel="alternate" type="application/rss+xml" href="https://rsdoiel.github.io/rss.xml" />
  <link rel="alternative" type="application/markdown" href="2018/02/24/go-based-python-modules.md">
</head>
<body>
<nav>
<ul>
<li><a href="/">R. S. Doiel</a></li>
<li><a href="/about.html">About</a></li>
<li><a href="/blog/">Blog</a></li>
<li><a href="/cv.html">CV</a></li>
<li><a href="https://github.com/rsdoiel">GitHub</a></li>
<li><a href="/library-terminology.html">Library Jargon</a></li>
<li><a href="/presentations.html">Presentations</a></li>
<li><a href="/projects.html">Projects</a></li>
<li><a href="/resume.html">Resume</a></li>
<li><a href="/search.html">Search</a></li>
<li><a href="/series/">Series</a></li>
</ul>
</nav>

<section>
  <article>
<h1 id="go-based-python-modules">Go based Python modules</h1>
<p>By R. S. Doiel, 2018-02-24</p>
<p>The problem: I have written a number of Go packages at work. My colleagues know Python and I’d like them to be able to use the packages without resorting to system calls from Python to the command line implementations. The solution is create a C-Shared library from my Go packages, using Go’s <em>C</em> package and combine it with Python’s <em>ctypes</em> package. What follows is a series of simple recipes I used to understand the details of how that worked.</p>
<h2 id="example-1-libtwice.go-and-twice.py">Example 1, libtwice.go and twice.py</h2>
<p>Many of the the examples I’ve come across on the web start by showing how to run a simple math operation on the Go side with numeric values traveling round trip via the C shared library layer. It is a good place to start as you only need to consider type conversion between both Python’s runtime and Go’s runtime. It provides a simple illustration of how the Go <em>C</em> package, Python’s <em>ctypes</em> module and the toolchain work together.</p>
<p>In this example we have a function in Go called “twice” it takes a single integer, doubles it and returns the new value. On the Go side we create a <em>libtwice.go</em> file with an empty <code>main()</code> function. Notice that we also import the <em>C</em> package and use a comment decoration to indicate the function we are exporting (see https://github.com/golang/go/wiki/cgo and https://golang.org/cmd/cgo/ for full story about Go’s <em>C</em> package and <em>cgo</em>). Part of the what <em>cgo</em> and the <em>C</em> package does is use the comment decoration to build the signatures for the function calls in the shared C library. The Go toolchain does all the heavy lifting in making a <em>C</em> shared library based on comment directives like “//export”. We don’t need much for our twice function.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode go"><code class="sourceCode go"><a class="sourceLine" id="cb1-1" title="1">    <span class="kw">package</span> main</a>
<a class="sourceLine" id="cb1-2" title="2">    </a>
<a class="sourceLine" id="cb1-3" title="3">    <span class="kw">import</span> (</a>
<a class="sourceLine" id="cb1-4" title="4">        <span class="st">&quot;C&quot;</span></a>
<a class="sourceLine" id="cb1-5" title="5">    )</a>
<a class="sourceLine" id="cb1-6" title="6">    </a>
<a class="sourceLine" id="cb1-7" title="7">    <span class="co">//export twice</span></a>
<a class="sourceLine" id="cb1-8" title="8">    <span class="kw">func</span> twice(i <span class="dt">int</span>) <span class="dt">int</span> {</a>
<a class="sourceLine" id="cb1-9" title="9">        <span class="kw">return</span> i * <span class="dv">2</span></a>
<a class="sourceLine" id="cb1-10" title="10">    }</a>
<a class="sourceLine" id="cb1-11" title="11">    </a>
<a class="sourceLine" id="cb1-12" title="12">    <span class="kw">func</span> main() {}</a></code></pre></div>
<p>On the python side we need to wrap our calls to our shared library bringing them into the Python runtime in a useful and idiomatically Python way. Python provides a few ways of doing this. In my examples I am using the <em>ctypes</em> package. <em>twice.py</em> looks like this–</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb2-1" title="1">    <span class="im">import</span> ctypes</a>
<a class="sourceLine" id="cb2-2" title="2">    <span class="im">import</span> os</a>
<a class="sourceLine" id="cb2-3" title="3">    </a>
<a class="sourceLine" id="cb2-4" title="4">    <span class="co"># Set our shared library&#39;s name</span></a>
<a class="sourceLine" id="cb2-5" title="5">    lib_name<span class="op">=</span><span class="st">&#39;libtwice&#39;</span></a>
<a class="sourceLine" id="cb2-6" title="6">    </a>
<a class="sourceLine" id="cb2-7" title="7">    <span class="co"># Figure out shared library extension</span></a>
<a class="sourceLine" id="cb2-8" title="8">    uname <span class="op">=</span> os.uname().sysname</a>
<a class="sourceLine" id="cb2-9" title="9">    ext <span class="op">=</span> <span class="st">&#39;.so&#39;</span></a>
<a class="sourceLine" id="cb2-10" title="10">    <span class="cf">if</span> uname <span class="op">==</span> <span class="st">&#39;Darwin&#39;</span>:</a>
<a class="sourceLine" id="cb2-11" title="11">        ext <span class="op">=</span> <span class="st">&#39;.dylib&#39;</span></a>
<a class="sourceLine" id="cb2-12" title="12">    <span class="cf">if</span> uname <span class="op">==</span> <span class="st">&#39;Windows&#39;</span>:</a>
<a class="sourceLine" id="cb2-13" title="13">        ext <span class="op">=</span> <span class="st">&#39;.dll&#39;</span></a>
<a class="sourceLine" id="cb2-14" title="14">    </a>
<a class="sourceLine" id="cb2-15" title="15">    <span class="co"># Find our shared library and load it</span></a>
<a class="sourceLine" id="cb2-16" title="16">    dir_path <span class="op">=</span> os.path.dirname(os.path.realpath(<span class="va">__file__</span>))</a>
<a class="sourceLine" id="cb2-17" title="17">    lib <span class="op">=</span> ctypes.cdll.LoadLibrary(os.path.join(dir_path, lib_name<span class="op">+</span>ext))</a>
<a class="sourceLine" id="cb2-18" title="18">    </a>
<a class="sourceLine" id="cb2-19" title="19">    <span class="co"># Setup our Go functions to be nicely wrapped</span></a>
<a class="sourceLine" id="cb2-20" title="20">    go_twice <span class="op">=</span> lib.twice</a>
<a class="sourceLine" id="cb2-21" title="21">    go_twice.argtypes <span class="op">=</span> [ctypes.c_int]</a>
<a class="sourceLine" id="cb2-22" title="22">    go_twice.restype <span class="op">=</span> ctypes.c_int</a>
<a class="sourceLine" id="cb2-23" title="23">    </a>
<a class="sourceLine" id="cb2-24" title="24">    <span class="co"># Now write our Python idiomatic function</span></a>
<a class="sourceLine" id="cb2-25" title="25">    <span class="kw">def</span> twice(i):</a>
<a class="sourceLine" id="cb2-26" title="26">        <span class="cf">return</span> go_twice(ctypes.c_int(i))</a>
<a class="sourceLine" id="cb2-27" title="27">    </a>
<a class="sourceLine" id="cb2-28" title="28">    <span class="co"># We run this test code if with: python3 twice.py</span></a>
<a class="sourceLine" id="cb2-29" title="29">    <span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&#39;__main__&#39;</span>:</a>
<a class="sourceLine" id="cb2-30" title="30">        <span class="bu">print</span>(<span class="st">&quot;Twice of 2 is&quot;</span>, twice(<span class="dv">2</span>))</a></code></pre></div>
<p>Notice the amount of lifting Python’s <em>ctypes</em> does for us. It provides for converting C based types to their Python counter parts. Indeed the additional Python source here is focused around using that functionality to create a simple Python function called twice. This pattern of bringing in a low level version of our desired function and then presenting in a Pythonic one is common in more complex C based Python modules. In general we need <em>ctypes</em> to access and wrapping our shared library. The <em>os</em> module is used so we can find our C shared library based on the naming conventions of our host OS. For simplicity I’ve kept the shared library (e.g. <em>libtwice.so</em> under Linux) in the same directory as the python module code <em>twice.py</em>.</p>
<p>The build command for Linux looks like—</p>
<pre class="shell"><code>    go build -buildmode=c-shared -o libtwice.so libtwice.go</code></pre>
<p>Under Windows it would look like—</p>
<pre class="shell"><code>    go build -buildmode=c-shared -o libtwice.dll libtwice.go</code></pre>
<p>and Mac OS X—</p>
<pre class="shell"><code>    go build -buildmode=c-shared -o libtwice.dynlib libtwice.go</code></pre>
<p>You can test the Python module with—</p>
<pre class="shell"><code>    python3 twice.py</code></pre>
<p>Notice the filename choices. I could have called the Go shared library anything as long as it wasn’t called <code>twice.so</code>, <code>twice.dll</code> or <code>twice.dylib</code>. This constraint is to avoid a module name collision in Python. If we had a Python script named <code>twice_test.py</code> and import <code>twice.py</code> then Python needs to make a distinction between <code>twice.py</code> and our shared library. If you use a Python package approach to wrapping the shared library you would have other options for voiding name collision.</p>
<p>Here is an example of <code>twice_test.py</code> to make sure out import is working.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb7-1" title="1">    <span class="im">import</span> twice</a>
<a class="sourceLine" id="cb7-2" title="2">    <span class="bu">print</span>(<span class="st">&quot;Twice 3&quot;</span>, twice.twice(<span class="dv">3</span>))</a></code></pre></div>
<p>Example 1 is our base recipe. The next examples focus on handling other data types but follow the same pattern.</p>
<h2 id="example-2-libsayhi.go-and-sayhi.py">Example 2, libsayhi.go and sayhi.py</h2>
<p>I found working with strings a little more nuanced. Go’s concept of strings are oriented to utf-8. Python has its own concept of strings and encoding. Both need to pass through the C layer which assumes strings are a char pointer pointing at contiguous memory ending in a null. The <em>sayhi</em> recipe is focused on moving a string from Python, to C, to Go (a one way trip this time). The example uses Go’s <em>fmt</em> package to display the string.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode go"><code class="sourceCode go"><a class="sourceLine" id="cb8-1" title="1">    <span class="kw">package</span> main</a>
<a class="sourceLine" id="cb8-2" title="2">    </a>
<a class="sourceLine" id="cb8-3" title="3">    <span class="kw">import</span> (</a>
<a class="sourceLine" id="cb8-4" title="4">        <span class="st">&quot;C&quot;</span></a>
<a class="sourceLine" id="cb8-5" title="5">        <span class="st">&quot;fmt&quot;</span></a>
<a class="sourceLine" id="cb8-6" title="6">    )</a>
<a class="sourceLine" id="cb8-7" title="7">    </a>
<a class="sourceLine" id="cb8-8" title="8">    <span class="co">//export say_hi</span></a>
<a class="sourceLine" id="cb8-9" title="9">    <span class="kw">func</span> say_hi(msg *C.char) {</a>
<a class="sourceLine" id="cb8-10" title="10">        fmt.Println(C.GoString(msg))</a>
<a class="sourceLine" id="cb8-11" title="11">    }</a>
<a class="sourceLine" id="cb8-12" title="12">    </a>
<a class="sourceLine" id="cb8-13" title="13">    <span class="kw">func</span> main() { }</a></code></pre></div>
<p>The Go source is similar to our first recipe but our Python modules needs to use <em>ctypes</em> to get you Python string into shape to be unpacked by Go.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb9-1" title="1">   <span class="im">import</span> ctypes</a>
<a class="sourceLine" id="cb9-2" title="2">   <span class="im">import</span> os</a>
<a class="sourceLine" id="cb9-3" title="3">   </a>
<a class="sourceLine" id="cb9-4" title="4">   <span class="co"># Set the name of our shared library</span></a>
<a class="sourceLine" id="cb9-5" title="5">   lib_name <span class="op">=</span> <span class="st">&#39;libsayhi&#39;</span></a>
<a class="sourceLine" id="cb9-6" title="6"></a>
<a class="sourceLine" id="cb9-7" title="7">   <span class="co"># Figure out shared library extension</span></a>
<a class="sourceLine" id="cb9-8" title="8">   uname <span class="op">=</span> os.uname().sysname</a>
<a class="sourceLine" id="cb9-9" title="9">   ext <span class="op">=</span> <span class="st">&#39;.so&#39;</span></a>
<a class="sourceLine" id="cb9-10" title="10">   <span class="cf">if</span> uname <span class="op">==</span> <span class="st">&#39;Darwin&#39;</span>:</a>
<a class="sourceLine" id="cb9-11" title="11">       ext <span class="op">=</span> <span class="st">&#39;.dylib&#39;</span></a>
<a class="sourceLine" id="cb9-12" title="12">   <span class="cf">if</span> uname <span class="op">==</span> <span class="st">&#39;Windows&#39;</span>:</a>
<a class="sourceLine" id="cb9-13" title="13">       ext <span class="op">=</span> <span class="st">&#39;.dll&#39;</span></a>
<a class="sourceLine" id="cb9-14" title="14">   </a>
<a class="sourceLine" id="cb9-15" title="15">   <span class="co"># Find our shared library and load it</span></a>
<a class="sourceLine" id="cb9-16" title="16">   dir_path <span class="op">=</span> os.path.dirname(os.path.realpath(<span class="va">__file__</span>))</a>
<a class="sourceLine" id="cb9-17" title="17">   lib <span class="op">=</span> ctypes.cdll.LoadLibrary(os.path.join(dir_path, lib_name<span class="op">+</span>ext))</a>
<a class="sourceLine" id="cb9-18" title="18">   </a>
<a class="sourceLine" id="cb9-19" title="19">   <span class="co"># Setup our Go functions to be nicely wrapped</span></a>
<a class="sourceLine" id="cb9-20" title="20">   go_say_hi <span class="op">=</span> lib.say_hi</a>
<a class="sourceLine" id="cb9-21" title="21">   go_say_hi.argtypes <span class="op">=</span> [ctypes.c_char_p]</a>
<a class="sourceLine" id="cb9-22" title="22">   <span class="co"># </span><span class="al">NOTE</span><span class="co">: we don&#39;t have a return type defined here, the message is </span></a>
<a class="sourceLine" id="cb9-23" title="23">   <span class="co"># displayed from Go</span></a>
<a class="sourceLine" id="cb9-24" title="24">   </a>
<a class="sourceLine" id="cb9-25" title="25">   <span class="co"># Now write our Python idiomatic function</span></a>
<a class="sourceLine" id="cb9-26" title="26">   <span class="kw">def</span> say_hi(txt):</a>
<a class="sourceLine" id="cb9-27" title="27">       <span class="cf">return</span> go_say_hi(ctypes.c_char_p(txt.encode(<span class="st">&#39;utf8&#39;</span>)))</a>
<a class="sourceLine" id="cb9-28" title="28">   </a>
<a class="sourceLine" id="cb9-29" title="29">   <span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&#39;__main__&#39;</span>:</a>
<a class="sourceLine" id="cb9-30" title="30">       say_hi(<span class="st">&#39;Hello!&#39;</span>)</a></code></pre></div>
<p>Putting things together (if you are using Windows or Mac OS X you’ll adjust name output name, <code>libsayhi.so</code>, to match the filename extension suitable for your operating system).</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb10-1" title="1">    <span class="ex">go</span> build -buildmode=c-shared -o libsayhi.so libsayhi.go</a></code></pre></div>
<p>and testing.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb11-1" title="1">    <span class="ex">python3</span> sayhi.py</a></code></pre></div>
<h2 id="example-3-libhelloworld.go-and-helloworld.py">Example 3, libhelloworld.go and helloworld.py</h2>
<p>In this example we send a Python string to Go (which expects utf-8) build our “hello world” message and then send it back to Python (which needs to do additional conversion and decoding).</p>
<p>Like in previous examples the Go side remains very simple. The heavy lifting is done by the <em>C</em> package and the comment <code>//export</code>. We are using <code>C.GoString()</code> and <code>C.CString()</code> to flip between our native Go and C datatypes.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode go"><code class="sourceCode go"><a class="sourceLine" id="cb12-1" title="1">    <span class="kw">package</span> main</a>
<a class="sourceLine" id="cb12-2" title="2">    </a>
<a class="sourceLine" id="cb12-3" title="3">    <span class="kw">import</span> (</a>
<a class="sourceLine" id="cb12-4" title="4">        <span class="st">&quot;C&quot;</span></a>
<a class="sourceLine" id="cb12-5" title="5">        <span class="st">&quot;fmt&quot;</span></a>
<a class="sourceLine" id="cb12-6" title="6">    )</a>
<a class="sourceLine" id="cb12-7" title="7">    </a>
<a class="sourceLine" id="cb12-8" title="8">    <span class="co">//export helloworld</span></a>
<a class="sourceLine" id="cb12-9" title="9">    <span class="kw">func</span> helloworld(name *C.char) *C.char {</a>
<a class="sourceLine" id="cb12-10" title="10">        txt := fmt.Sprintf(<span class="st">&quot;Hello %s&quot;</span>, C.GoString(name))</a>
<a class="sourceLine" id="cb12-11" title="11">        <span class="kw">return</span> C.CString(txt)</a>
<a class="sourceLine" id="cb12-12" title="12">    }</a>
<a class="sourceLine" id="cb12-13" title="13">    </a>
<a class="sourceLine" id="cb12-14" title="14">    <span class="kw">func</span> main() { }</a></code></pre></div>
<p>In the python code below the conversion process is much more detailed. Python isn’t explicitly utf-8 like Go. Plus we’re sending our Python string via C’s char arrays (or pointer to chars). Finally when we comeback from Go via C we have to put things back in order for Python. Of particular note is checking how the byte arrays work then encoding/decoding everything as needed. We also explicitly set the result type from our Go version of the helloworld function.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb13-1" title="1">    <span class="im">import</span> ctypes</a>
<a class="sourceLine" id="cb13-2" title="2">    <span class="im">import</span> os</a>
<a class="sourceLine" id="cb13-3" title="3">    </a>
<a class="sourceLine" id="cb13-4" title="4">    <span class="co"># Set the name of our shared library</span></a>
<a class="sourceLine" id="cb13-5" title="5">    lib_name <span class="op">=</span> <span class="st">&#39;libhelloworld&#39;</span></a>
<a class="sourceLine" id="cb13-6" title="6"></a>
<a class="sourceLine" id="cb13-7" title="7">    <span class="co"># Figure out shared library extension</span></a>
<a class="sourceLine" id="cb13-8" title="8">    uname <span class="op">=</span> os.uname().sysname</a>
<a class="sourceLine" id="cb13-9" title="9">    ext <span class="op">=</span> <span class="st">&#39;.so&#39;</span></a>
<a class="sourceLine" id="cb13-10" title="10">    <span class="cf">if</span> uname <span class="op">==</span> <span class="st">&#39;Darwin&#39;</span>:</a>
<a class="sourceLine" id="cb13-11" title="11">        ext <span class="op">=</span> <span class="st">&#39;.dylib&#39;</span></a>
<a class="sourceLine" id="cb13-12" title="12">    <span class="cf">if</span> uname <span class="op">==</span> <span class="st">&#39;Windows&#39;</span>:</a>
<a class="sourceLine" id="cb13-13" title="13">        ext <span class="op">=</span> <span class="st">&#39;.dll&#39;</span></a>
<a class="sourceLine" id="cb13-14" title="14">    </a>
<a class="sourceLine" id="cb13-15" title="15">    <span class="co"># Find our shared library and load it</span></a>
<a class="sourceLine" id="cb13-16" title="16">    dir_path <span class="op">=</span> os.path.dirname(os.path.realpath(<span class="va">__file__</span>))</a>
<a class="sourceLine" id="cb13-17" title="17">    lib <span class="op">=</span> ctypes.cdll.LoadLibrary(os.path.join(dir_path, lib_name<span class="op">+</span>ext))</a>
<a class="sourceLine" id="cb13-18" title="18">    </a>
<a class="sourceLine" id="cb13-19" title="19">    <span class="co"># Setup our Go functions to be nicely wrapped</span></a>
<a class="sourceLine" id="cb13-20" title="20">    go_helloworld <span class="op">=</span> lib.helloworld</a>
<a class="sourceLine" id="cb13-21" title="21">    go_helloworld.argtypes <span class="op">=</span> [ctypes.c_char_p]</a>
<a class="sourceLine" id="cb13-22" title="22">    go_helloworld.restype <span class="op">=</span> ctypes.c_char_p</a>
<a class="sourceLine" id="cb13-23" title="23">    </a>
<a class="sourceLine" id="cb13-24" title="24">    <span class="co"># Now write our Python idiomatic function</span></a>
<a class="sourceLine" id="cb13-25" title="25">    <span class="kw">def</span> helloworld(txt):</a>
<a class="sourceLine" id="cb13-26" title="26">        value <span class="op">=</span> go_helloworld(ctypes.c_char_p(txt.encode(<span class="st">&#39;utf8&#39;</span>)))</a>
<a class="sourceLine" id="cb13-27" title="27">        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(value, <span class="bu">bytes</span>):</a>
<a class="sourceLine" id="cb13-28" title="28">            value <span class="op">=</span> value.encode(<span class="st">&#39;utf-8&#39;</span>)</a>
<a class="sourceLine" id="cb13-29" title="29">        <span class="cf">return</span> value.decode()</a>
<a class="sourceLine" id="cb13-30" title="30">    </a>
<a class="sourceLine" id="cb13-31" title="31">    </a>
<a class="sourceLine" id="cb13-32" title="32">    <span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&#39;__main__&#39;</span>:</a>
<a class="sourceLine" id="cb13-33" title="33">        <span class="im">import</span> sys</a>
<a class="sourceLine" id="cb13-34" title="34">        <span class="cf">if</span> <span class="bu">len</span>(sys.argv) <span class="op">&gt;</span> <span class="dv">1</span>:</a>
<a class="sourceLine" id="cb13-35" title="35">            <span class="bu">print</span>(helloworld(sys.argv[<span class="dv">1</span>]))</a>
<a class="sourceLine" id="cb13-36" title="36">        <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb13-37" title="37">            <span class="bu">print</span>(helloworld(<span class="st">&#39;World&#39;</span>))</a></code></pre></div>
<p>The build recipe remains the same as the two previous examples.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb14-1" title="1">    <span class="ex">go</span> build -buildmode=c-shared -o libhelloworld.so libhelloworld.go</a></code></pre></div>
<p>Here are two variations to test.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb15-1" title="1">     <span class="ex">python3</span> helloworld.py</a>
<a class="sourceLine" id="cb15-2" title="2">     <span class="ex">python3</span> helloworld.py Jane</a></code></pre></div>
<h2 id="example-4-libjsonpretty.go-and-jsonpretty.py">Example 4, libjsonpretty.go and jsonpretty.py</h2>
<p>In this example we send JSON encode text to the Go package, unpack it in Go’s runtime and repack it using the <code>MarshalIndent()</code> function in Go’s JSON package before sending it back as Python in string form. You’ll see the same encode/decode patterns as in our <em>helloworld</em> example.</p>
<p>Go code</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode go"><code class="sourceCode go"><a class="sourceLine" id="cb16-1" title="1">    <span class="kw">package</span> main</a>
<a class="sourceLine" id="cb16-2" title="2">    </a>
<a class="sourceLine" id="cb16-3" title="3">    <span class="kw">import</span> (</a>
<a class="sourceLine" id="cb16-4" title="4">        <span class="st">&quot;C&quot;</span></a>
<a class="sourceLine" id="cb16-5" title="5">        <span class="st">&quot;encoding/json&quot;</span></a>
<a class="sourceLine" id="cb16-6" title="6">        <span class="st">&quot;fmt&quot;</span></a>
<a class="sourceLine" id="cb16-7" title="7">        <span class="st">&quot;log&quot;</span></a>
<a class="sourceLine" id="cb16-8" title="8">    )</a>
<a class="sourceLine" id="cb16-9" title="9">    </a>
<a class="sourceLine" id="cb16-10" title="10">    <span class="co">//export jsonpretty</span></a>
<a class="sourceLine" id="cb16-11" title="11">    <span class="kw">func</span> jsonpretty(rawSrc *C.char) *C.char {</a>
<a class="sourceLine" id="cb16-12" title="12">        data := <span class="bu">new</span>(<span class="kw">map</span>[<span class="dt">string</span>]<span class="kw">interface</span>{})</a>
<a class="sourceLine" id="cb16-13" title="13">        err := json.Unmarshal([]<span class="dt">byte</span>(C.GoString(rawSrc)), &amp;data)</a>
<a class="sourceLine" id="cb16-14" title="14">        <span class="kw">if</span> err != <span class="ot">nil</span> {</a>
<a class="sourceLine" id="cb16-15" title="15">            log.Printf(<span class="st">&quot;%s&quot;</span>, err)</a>
<a class="sourceLine" id="cb16-16" title="16">            <span class="kw">return</span> C.CString(<span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb16-17" title="17">        }</a>
<a class="sourceLine" id="cb16-18" title="18">        src, err := json.MarshalIndent(data, <span class="st">&quot;&quot;</span>, <span class="st">&quot;    &quot;</span>)</a>
<a class="sourceLine" id="cb16-19" title="19">        <span class="kw">if</span> err != <span class="ot">nil</span> {</a>
<a class="sourceLine" id="cb16-20" title="20">            log.Printf(<span class="st">&quot;%s&quot;</span>, err)</a>
<a class="sourceLine" id="cb16-21" title="21">            <span class="kw">return</span> C.CString(<span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb16-22" title="22">        }</a>
<a class="sourceLine" id="cb16-23" title="23">        txt := fmt.Sprintf(<span class="st">&quot;%s&quot;</span>, src)</a>
<a class="sourceLine" id="cb16-24" title="24">        <span class="kw">return</span> C.CString(txt)</a>
<a class="sourceLine" id="cb16-25" title="25">    }</a>
<a class="sourceLine" id="cb16-26" title="26">    </a>
<a class="sourceLine" id="cb16-27" title="27">    <span class="kw">func</span> main() {}</a></code></pre></div>
<p>Python code</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb17-1" title="1">    <span class="im">import</span> ctypes</a>
<a class="sourceLine" id="cb17-2" title="2">    <span class="im">import</span> os</a>
<a class="sourceLine" id="cb17-3" title="3">    <span class="im">import</span> json</a>
<a class="sourceLine" id="cb17-4" title="4">    </a>
<a class="sourceLine" id="cb17-5" title="5">    <span class="co"># Set the name of our shared library</span></a>
<a class="sourceLine" id="cb17-6" title="6">    lib_name <span class="op">=</span> <span class="st">&#39;libjsonpretty&#39;</span></a>
<a class="sourceLine" id="cb17-7" title="7"></a>
<a class="sourceLine" id="cb17-8" title="8">    <span class="co"># Figure out shared library extension</span></a>
<a class="sourceLine" id="cb17-9" title="9">    uname <span class="op">=</span> os.uname().sysname</a>
<a class="sourceLine" id="cb17-10" title="10">    ext <span class="op">=</span> <span class="st">&#39;.so&#39;</span></a>
<a class="sourceLine" id="cb17-11" title="11">    <span class="cf">if</span> uname <span class="op">==</span> <span class="st">&#39;Darwin&#39;</span>:</a>
<a class="sourceLine" id="cb17-12" title="12">        ext <span class="op">=</span> <span class="st">&#39;.dylib&#39;</span></a>
<a class="sourceLine" id="cb17-13" title="13">    <span class="cf">if</span> uname <span class="op">==</span> <span class="st">&#39;Windows&#39;</span>:</a>
<a class="sourceLine" id="cb17-14" title="14">        ext <span class="op">=</span> <span class="st">&#39;.dll&#39;</span></a>
<a class="sourceLine" id="cb17-15" title="15"></a>
<a class="sourceLine" id="cb17-16" title="16">    dir_path <span class="op">=</span> os.path.dirname(os.path.realpath(<span class="va">__file__</span>))</a>
<a class="sourceLine" id="cb17-17" title="17">    lib <span class="op">=</span> ctypes.cdll.LoadLibrary(os.path.join(dir_path, lib_name<span class="op">+</span>ext))</a>
<a class="sourceLine" id="cb17-18" title="18">    </a>
<a class="sourceLine" id="cb17-19" title="19">    go_jsonpretty <span class="op">=</span> lib.jsonpretty</a>
<a class="sourceLine" id="cb17-20" title="20">    go_jsonpretty.argtypes <span class="op">=</span> [ctypes.c_char_p]</a>
<a class="sourceLine" id="cb17-21" title="21">    go_jsonpretty.restype <span class="op">=</span> ctypes.c_char_p</a>
<a class="sourceLine" id="cb17-22" title="22">    </a>
<a class="sourceLine" id="cb17-23" title="23">    <span class="kw">def</span> jsonpretty(txt):</a>
<a class="sourceLine" id="cb17-24" title="24">        value <span class="op">=</span> go_jsonpretty(ctypes.c_char_p(txt.encode(<span class="st">&#39;utf8&#39;</span>)))</a>
<a class="sourceLine" id="cb17-25" title="25">        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(value, <span class="bu">bytes</span>):</a>
<a class="sourceLine" id="cb17-26" title="26">            value <span class="op">=</span> value.encode(<span class="st">&#39;utf-8&#39;</span>)</a>
<a class="sourceLine" id="cb17-27" title="27">        <span class="cf">return</span> value.decode()</a>
<a class="sourceLine" id="cb17-28" title="28">    </a>
<a class="sourceLine" id="cb17-29" title="29">    <span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&#39;__main__&#39;</span>:</a>
<a class="sourceLine" id="cb17-30" title="30">        src <span class="op">=</span> <span class="st">&#39;&#39;&#39;</span></a>
<a class="sourceLine" id="cb17-31" title="31"><span class="st">    {&quot;name&quot;:&quot;fred&quot;,&quot;age&quot;:25,&quot;height&quot;:75,&quot;units&quot;:&quot;inch&quot;,&quot;weight&quot;:&quot;239&quot;}</span></a>
<a class="sourceLine" id="cb17-32" title="32"><span class="st">    &#39;&#39;&#39;</span></a>
<a class="sourceLine" id="cb17-33" title="33">        value <span class="op">=</span> jsonpretty(src)</a>
<a class="sourceLine" id="cb17-34" title="34">        <span class="bu">print</span>(<span class="st">&quot;Pretty print&quot;</span>)</a>
<a class="sourceLine" id="cb17-35" title="35">        <span class="bu">print</span>(value)</a>
<a class="sourceLine" id="cb17-36" title="36">        <span class="bu">print</span>(<span class="st">&quot;Decode into dict&quot;</span>)</a>
<a class="sourceLine" id="cb17-37" title="37">        o <span class="op">=</span> json.loads(value)</a>
<a class="sourceLine" id="cb17-38" title="38">        <span class="bu">print</span>(o)</a></code></pre></div>
<p>Build command</p>
<pre class="shell"><code>    go build -buildmode=c-shared -o libjsonpretty.so libjsonpretty.go</code></pre>
<p>As before you can run your tests with <code>python3 jsonpretty.py</code>.</p>
<p>In closing I would like to note that to use these examples you Python3 will need to be able to find the module and shared library. For simplicity I’ve put all the code in the same directory. If your Python code is spread across multiple directories you’ll need to make some adjustments.</p>
  </article>
</section>

<footer>
<p>copyright © 2016 - 2021 R. S. Doiel<br /> <a href="/rssfeed.html">RSS</a> feed and website built with <a href="https://caltechlibrary.github.io/mkpage">mkpage</a>, <a href="https://caltechlibrary.github.io/datatools">datatools</a>, Bash, Make and <a href="https://pandoc.org">Pandoc</a>.</p>
</footer>
<!-- START: PrettyFi from https://github.com/google/code-prettify -->
<script>
/* We want to add the class "prettyprint" to all the pre elements */
var pre_list = document.querySelectorAll("pre");

pre_list.forEach(function(elem) {
    elem.classList.add("prettyprint");
    elem.classList.add("linenums");/**/
    elem.classList.add("json"); /**/
});
</script>
<style>
li.L0, li.L1, li.L2, li.L3, li.L4, li.L5, li.L6, li.L7, li.L8, li.L9
{
    color: #555;
    list-style-type: decimal;
}
</style>
<link rel="stylesheet" type="text/css" href="/css/prettify.css">
<script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_
prettify.js"></script>
<!--  END: PrettyFi from https://github.com/google/code-prettify -->

</body>
</html>
