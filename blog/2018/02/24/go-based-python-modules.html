<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="language" content="EN">
  <title>go-based-python-modules</title>

  <link rel="stylesheet" type="text/css"  href="/printfonts/print.css" media="print" />
  <link rel="stylesheet" type="text/css"  href="/webfonts/fonts.css" media="screen" />
  <link rel="stylesheet" type="text/css"  href="/css/site.css" media="screen" />
  <link rel="stylesheet" type="text/css"  href="/css/tables.css" media="screen" />
  <link title="RSS feed for rsdoiel's blog" rel="alternate" type="application/rss+xml" href="https://rsdoiel.github.io/rss.xml" />
  <meta name="keywords" content="Golang, Python, shared libraries">
  <link rel="alternative" type="application/markdown" href="/blog/2018/02/24/go-based-python-modules.md">
  <link rel="search" type="application/opensearchdescription+xml"
        title="Robert's Rambling Search Engine"
        href="search.osdx">
</head>
<body>
<nav>
<ul>
<li><a href="/">R. S. Doiel</a></li>
<li><a href="/about.html">About</a></li>
<li><a href="/blog/">Blog</a></li>
<li><a href="/cv.html">CV</a></li>
<li><a href="https://github.com/rsdoiel">GitHub</a></li>
<li><a href="/library-terminology.html">Library Jargon</a></li>
<li><a href="/presentations.html">Presentations</a></li>
<li><a href="/projects.html">Projects</a></li>
<li><a href="/resume.html">Resume</a></li>
<li><a href="/search.html">Search</a></li>
<li><a href="/series/">Series</a></li>
</ul>
</nav>

<section>
  <article>
  <a data-pocket-label="pocket" data-pocket-count="none" class="pocket-btn" data-lang="en"></a>
<script type="text/javascript">!function(d,i){if(!d.getElementById(i)){var j=d.createElement("script");j.id=i;j.src="https://widgets.getpocket.com/v1/j/btn.js?v=1";var w=d.getElementById(i);d.body.appendChild(j);}}(document,"pocket-btn-js");</script>
<h1 id="go-based-python-modules">Go based Python modules</h1>
<p>By R. S. Doiel, 2018-02-24</p>
<p>The problem: I have written a number of Go packages at work. My
colleagues know Python and I’d like them to be able to use the packages
without resorting to system calls from Python to the command line
implementations. The solution is create a C-Shared library from my Go
packages, using Go’s <em>C</em> package and combine it with Python’s
<em>ctypes</em> package. What follows is a series of simple recipes I
used to understand the details of how that worked.</p>
<h2 id="example-1-libtwice.go-and-twice.py">Example 1, libtwice.go and
twice.py</h2>
<p>Many of the the examples I’ve come across on the web start by showing
how to run a simple math operation on the Go side with numeric values
traveling round trip via the C shared library layer. It is a good place
to start as you only need to consider type conversion between both
Python’s runtime and Go’s runtime. It provides a simple illustration of
how the Go <em>C</em> package, Python’s <em>ctypes</em> module and the
toolchain work together.</p>
<p>In this example we have a function in Go called “twice” it takes a
single integer, doubles it and returns the new value. On the Go side we
create a <em>libtwice.go</em> file with an empty <code>main()</code>
function. Notice that we also import the <em>C</em> package and use a
comment decoration to indicate the function we are exporting (see
https://github.com/golang/go/wiki/cgo and https://golang.org/cmd/cgo/
for full story about Go’s <em>C</em> package and <em>cgo</em>). Part of
the what <em>cgo</em> and the <em>C</em> package does is use the comment
decoration to build the signatures for the function calls in the shared
C library. The Go toolchain does all the heavy lifting in making a
<em>C</em> shared library based on comment directives like “//export”.
We don’t need much for our twice function.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">package</span> main</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">import</span> <span class="op">(</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;C&quot;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">//export twice</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> twice<span class="op">(</span>i <span class="dt">int</span><span class="op">)</span> <span class="dt">int</span> <span class="op">{</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> i <span class="op">*</span> <span class="dv">2</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> main<span class="op">()</span> <span class="op">{}</span></span></code></pre></div>
<p>On the python side we need to wrap our calls to our shared library
bringing them into the Python runtime in a useful and idiomatically
Python way. Python provides a few ways of doing this. In my examples I
am using the <em>ctypes</em> package. <em>twice.py</em> looks like
this–</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> ctypes</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> os</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set our shared library&#39;s name</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    lib_name<span class="op">=</span><span class="st">&#39;libtwice&#39;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Figure out shared library extension</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    uname <span class="op">=</span> os.uname().sysname</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    ext <span class="op">=</span> <span class="st">&#39;.so&#39;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> uname <span class="op">==</span> <span class="st">&#39;Darwin&#39;</span>:</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        ext <span class="op">=</span> <span class="st">&#39;.dylib&#39;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> uname <span class="op">==</span> <span class="st">&#39;Windows&#39;</span>:</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        ext <span class="op">=</span> <span class="st">&#39;.dll&#39;</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find our shared library and load it</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    dir_path <span class="op">=</span> os.path.dirname(os.path.realpath(<span class="va">__file__</span>))</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    lib <span class="op">=</span> ctypes.cdll.LoadLibrary(os.path.join(dir_path, lib_name<span class="op">+</span>ext))</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Setup our Go functions to be nicely wrapped</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    go_twice <span class="op">=</span> lib.twice</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    go_twice.argtypes <span class="op">=</span> [ctypes.c_int]</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    go_twice.restype <span class="op">=</span> ctypes.c_int</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Now write our Python idiomatic function</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> twice(i):</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> go_twice(ctypes.c_int(i))</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We run this test code if with: python3 twice.py</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&#39;__main__&#39;</span>:</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;Twice of 2 is&quot;</span>, twice(<span class="dv">2</span>))</span></code></pre></div>
<p>Notice the amount of lifting Python’s <em>ctypes</em> does for us. It
provides for converting C based types to their Python counter parts.
Indeed the additional Python source here is focused around using that
functionality to create a simple Python function called twice. This
pattern of bringing in a low level version of our desired function and
then presenting in a Pythonic one is common in more complex C based
Python modules. In general we need <em>ctypes</em> to access and
wrapping our shared library. The <em>os</em> module is used so we can
find our C shared library based on the naming conventions of our host
OS. For simplicity I’ve kept the shared library
(e.g. <em>libtwice.so</em> under Linux) in the same directory as the
python module code <em>twice.py</em>.</p>
<p>The build command for Linux looks like—</p>
<pre class="shell"><code>    go build -buildmode=c-shared -o libtwice.so libtwice.go</code></pre>
<p>Under Windows it would look like—</p>
<pre class="shell"><code>    go build -buildmode=c-shared -o libtwice.dll libtwice.go</code></pre>
<p>and Mac OS X—</p>
<pre class="shell"><code>    go build -buildmode=c-shared -o libtwice.dynlib libtwice.go</code></pre>
<p>You can test the Python module with—</p>
<pre class="shell"><code>    python3 twice.py</code></pre>
<p>Notice the filename choices. I could have called the Go shared
library anything as long as it wasn’t called <code>twice.so</code>,
<code>twice.dll</code> or <code>twice.dylib</code>. This constraint is
to avoid a module name collision in Python. If we had a Python script
named <code>twice_test.py</code> and import <code>twice.py</code> then
Python needs to make a distinction between <code>twice.py</code> and our
shared library. If you use a Python package approach to wrapping the
shared library you would have other options for voiding name
collision.</p>
<p>Here is an example of <code>twice_test.py</code> to make sure out
import is working.</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> twice</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Twice 3&quot;</span>, twice.twice(<span class="dv">3</span>))</span></code></pre></div>
<p>Example 1 is our base recipe. The next examples focus on handling
other data types but follow the same pattern.</p>
<h2 id="example-2-libsayhi.go-and-sayhi.py">Example 2, libsayhi.go and
sayhi.py</h2>
<p>I found working with strings a little more nuanced. Go’s concept of
strings are oriented to utf-8. Python has its own concept of strings and
encoding. Both need to pass through the C layer which assumes strings
are a char pointer pointing at contiguous memory ending in a null. The
<em>sayhi</em> recipe is focused on moving a string from Python, to C,
to Go (a one way trip this time). The example uses Go’s <em>fmt</em>
package to display the string.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">package</span> main</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">import</span> <span class="op">(</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;C&quot;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;fmt&quot;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">//export say_hi</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> say_hi<span class="op">(</span>msg <span class="op">*</span>C<span class="op">.</span>char<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        fmt<span class="op">.</span>Println<span class="op">(</span>C<span class="op">.</span>GoString<span class="op">(</span>msg<span class="op">))</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span> <span class="op">}</span></span></code></pre></div>
<p>The Go source is similar to our first recipe but our Python modules
needs to use <em>ctypes</em> to get you Python string into shape to be
unpacked by Go.</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>   <span class="im">import</span> ctypes</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>   <span class="im">import</span> os</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Set the name of our shared library</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>   lib_name <span class="op">=</span> <span class="st">&#39;libsayhi&#39;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Figure out shared library extension</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>   uname <span class="op">=</span> os.uname().sysname</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>   ext <span class="op">=</span> <span class="st">&#39;.so&#39;</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>   <span class="cf">if</span> uname <span class="op">==</span> <span class="st">&#39;Darwin&#39;</span>:</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>       ext <span class="op">=</span> <span class="st">&#39;.dylib&#39;</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>   <span class="cf">if</span> uname <span class="op">==</span> <span class="st">&#39;Windows&#39;</span>:</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>       ext <span class="op">=</span> <span class="st">&#39;.dll&#39;</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Find our shared library and load it</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>   dir_path <span class="op">=</span> os.path.dirname(os.path.realpath(<span class="va">__file__</span>))</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>   lib <span class="op">=</span> ctypes.cdll.LoadLibrary(os.path.join(dir_path, lib_name<span class="op">+</span>ext))</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Setup our Go functions to be nicely wrapped</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>   go_say_hi <span class="op">=</span> lib.say_hi</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>   go_say_hi.argtypes <span class="op">=</span> [ctypes.c_char_p]</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>   <span class="co"># </span><span class="al">NOTE</span><span class="co">: we don&#39;t have a return type defined here, the message is </span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>   <span class="co"># displayed from Go</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Now write our Python idiomatic function</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>   <span class="kw">def</span> say_hi(txt):</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>       <span class="cf">return</span> go_say_hi(ctypes.c_char_p(txt.encode(<span class="st">&#39;utf8&#39;</span>)))</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>   <span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&#39;__main__&#39;</span>:</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>       say_hi(<span class="st">&#39;Hello!&#39;</span>)</span></code></pre></div>
<p>Putting things together (if you are using Windows or Mac OS X you’ll
adjust name output name, <code>libsayhi.so</code>, to match the filename
extension suitable for your operating system).</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>    <span class="ex">go</span> build <span class="at">-buildmode</span><span class="op">=</span>c-shared <span class="at">-o</span> libsayhi.so libsayhi.go</span></code></pre></div>
<p>and testing.</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>    <span class="ex">python3</span> sayhi.py</span></code></pre></div>
<h2 id="example-3-libhelloworld.go-and-helloworld.py">Example 3,
libhelloworld.go and helloworld.py</h2>
<p>In this example we send a Python string to Go (which expects utf-8)
build our “hello world” message and then send it back to Python (which
needs to do additional conversion and decoding).</p>
<p>Like in previous examples the Go side remains very simple. The heavy
lifting is done by the <em>C</em> package and the comment
<code>//export</code>. We are using <code>C.GoString()</code> and
<code>C.CString()</code> to flip between our native Go and C
datatypes.</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">package</span> main</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">import</span> <span class="op">(</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;C&quot;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;fmt&quot;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">//export helloworld</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> helloworld<span class="op">(</span>name <span class="op">*</span>C<span class="op">.</span>char<span class="op">)</span> <span class="op">*</span>C<span class="op">.</span>char <span class="op">{</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        txt <span class="op">:=</span> fmt<span class="op">.</span>Sprintf<span class="op">(</span><span class="st">&quot;Hello %s&quot;</span><span class="op">,</span> C<span class="op">.</span>GoString<span class="op">(</span>name<span class="op">))</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> C<span class="op">.</span>CString<span class="op">(</span>txt<span class="op">)</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span> <span class="op">}</span></span></code></pre></div>
<p>In the python code below the conversion process is much more
detailed. Python isn’t explicitly utf-8 like Go. Plus we’re sending our
Python string via C’s char arrays (or pointer to chars). Finally when we
comeback from Go via C we have to put things back in order for Python.
Of particular note is checking how the byte arrays work then
encoding/decoding everything as needed. We also explicitly set the
result type from our Go version of the helloworld function.</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> ctypes</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> os</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set the name of our shared library</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    lib_name <span class="op">=</span> <span class="st">&#39;libhelloworld&#39;</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Figure out shared library extension</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    uname <span class="op">=</span> os.uname().sysname</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    ext <span class="op">=</span> <span class="st">&#39;.so&#39;</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> uname <span class="op">==</span> <span class="st">&#39;Darwin&#39;</span>:</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        ext <span class="op">=</span> <span class="st">&#39;.dylib&#39;</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> uname <span class="op">==</span> <span class="st">&#39;Windows&#39;</span>:</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>        ext <span class="op">=</span> <span class="st">&#39;.dll&#39;</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find our shared library and load it</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    dir_path <span class="op">=</span> os.path.dirname(os.path.realpath(<span class="va">__file__</span>))</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    lib <span class="op">=</span> ctypes.cdll.LoadLibrary(os.path.join(dir_path, lib_name<span class="op">+</span>ext))</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Setup our Go functions to be nicely wrapped</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    go_helloworld <span class="op">=</span> lib.helloworld</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    go_helloworld.argtypes <span class="op">=</span> [ctypes.c_char_p]</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    go_helloworld.restype <span class="op">=</span> ctypes.c_char_p</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Now write our Python idiomatic function</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> helloworld(txt):</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>        value <span class="op">=</span> go_helloworld(ctypes.c_char_p(txt.encode(<span class="st">&#39;utf8&#39;</span>)))</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(value, <span class="bu">bytes</span>):</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>            value <span class="op">=</span> value.encode(<span class="st">&#39;utf-8&#39;</span>)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> value.decode()</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&#39;__main__&#39;</span>:</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> sys</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(sys.argv) <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(helloworld(sys.argv[<span class="dv">1</span>]))</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(helloworld(<span class="st">&#39;World&#39;</span>))</span></code></pre></div>
<p>The build recipe remains the same as the two previous examples.</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>    <span class="ex">go</span> build <span class="at">-buildmode</span><span class="op">=</span>c-shared <span class="at">-o</span> libhelloworld.so libhelloworld.go</span></code></pre></div>
<p>Here are two variations to test.</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>     <span class="ex">python3</span> helloworld.py</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>     <span class="ex">python3</span> helloworld.py Jane</span></code></pre></div>
<h2 id="example-4-libjsonpretty.go-and-jsonpretty.py">Example 4,
libjsonpretty.go and jsonpretty.py</h2>
<p>In this example we send JSON encode text to the Go package, unpack it
in Go’s runtime and repack it using the <code>MarshalIndent()</code>
function in Go’s JSON package before sending it back as Python in string
form. You’ll see the same encode/decode patterns as in our
<em>helloworld</em> example.</p>
<p>Go code</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">package</span> main</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">import</span> <span class="op">(</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;C&quot;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;encoding/json&quot;</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;fmt&quot;</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;log&quot;</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">//export jsonpretty</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> jsonpretty<span class="op">(</span>rawSrc <span class="op">*</span>C<span class="op">.</span>char<span class="op">)</span> <span class="op">*</span>C<span class="op">.</span>char <span class="op">{</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>        data <span class="op">:=</span> <span class="bu">new</span><span class="op">(</span><span class="kw">map</span><span class="op">[</span><span class="dt">string</span><span class="op">]</span><span class="kw">interface</span><span class="op">{})</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>        err <span class="op">:=</span> json<span class="op">.</span>Unmarshal<span class="op">([]</span><span class="dt">byte</span><span class="op">(</span>C<span class="op">.</span>GoString<span class="op">(</span>rawSrc<span class="op">)),</span> <span class="op">&amp;</span>data<span class="op">)</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>            log<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;%s&quot;</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> C<span class="op">.</span>CString<span class="op">(</span><span class="st">&quot;&quot;</span><span class="op">)</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>        src<span class="op">,</span> err <span class="op">:=</span> json<span class="op">.</span>MarshalIndent<span class="op">(</span>data<span class="op">,</span> <span class="st">&quot;&quot;</span><span class="op">,</span> <span class="st">&quot;    &quot;</span><span class="op">)</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>            log<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;%s&quot;</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> C<span class="op">.</span>CString<span class="op">(</span><span class="st">&quot;&quot;</span><span class="op">)</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>        txt <span class="op">:=</span> fmt<span class="op">.</span>Sprintf<span class="op">(</span><span class="st">&quot;%s&quot;</span><span class="op">,</span> src<span class="op">)</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> C<span class="op">.</span>CString<span class="op">(</span>txt<span class="op">)</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> main<span class="op">()</span> <span class="op">{}</span></span></code></pre></div>
<p>Python code</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> ctypes</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> os</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> json</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set the name of our shared library</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    lib_name <span class="op">=</span> <span class="st">&#39;libjsonpretty&#39;</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Figure out shared library extension</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    uname <span class="op">=</span> os.uname().sysname</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    ext <span class="op">=</span> <span class="st">&#39;.so&#39;</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> uname <span class="op">==</span> <span class="st">&#39;Darwin&#39;</span>:</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>        ext <span class="op">=</span> <span class="st">&#39;.dylib&#39;</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> uname <span class="op">==</span> <span class="st">&#39;Windows&#39;</span>:</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>        ext <span class="op">=</span> <span class="st">&#39;.dll&#39;</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    dir_path <span class="op">=</span> os.path.dirname(os.path.realpath(<span class="va">__file__</span>))</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    lib <span class="op">=</span> ctypes.cdll.LoadLibrary(os.path.join(dir_path, lib_name<span class="op">+</span>ext))</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    go_jsonpretty <span class="op">=</span> lib.jsonpretty</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    go_jsonpretty.argtypes <span class="op">=</span> [ctypes.c_char_p]</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    go_jsonpretty.restype <span class="op">=</span> ctypes.c_char_p</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> jsonpretty(txt):</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>        value <span class="op">=</span> go_jsonpretty(ctypes.c_char_p(txt.encode(<span class="st">&#39;utf8&#39;</span>)))</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(value, <span class="bu">bytes</span>):</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>            value <span class="op">=</span> value.encode(<span class="st">&#39;utf-8&#39;</span>)</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> value.decode()</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&#39;__main__&#39;</span>:</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>        src <span class="op">=</span> <span class="st">&#39;&#39;&#39;</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a><span class="st">    {&quot;name&quot;:&quot;fred&quot;,&quot;age&quot;:25,&quot;height&quot;:75,&quot;units&quot;:&quot;inch&quot;,&quot;weight&quot;:&quot;239&quot;}</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a><span class="st">    &#39;&#39;&#39;</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>        value <span class="op">=</span> jsonpretty(src)</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;Pretty print&quot;</span>)</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(value)</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;Decode into dict&quot;</span>)</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>        o <span class="op">=</span> json.loads(value)</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(o)</span></code></pre></div>
<p>Build command</p>
<pre class="shell"><code>    go build -buildmode=c-shared -o libjsonpretty.so libjsonpretty.go</code></pre>
<p>As before you can run your tests with
<code>python3 jsonpretty.py</code>.</p>
<p>In closing I would like to note that to use these examples you
Python3 will need to be able to find the module and shared library. For
simplicity I’ve put all the code in the same directory. If your Python
code is spread across multiple directories you’ll need to make some
adjustments.</p>
  </article>
</section>

<footer>
<p>copyright © 2016 - 2023 R. S. Doiel<br /> <a
href="/rssfeed.html">RSS</a> feeds and website built with <a
href="https://rsdoiel.github.io/pttk">pttk</a>, Bash, Make and <a
href="https://pandoc.org">Pandoc</a>.</p>
</footer>
<!-- START: PrettyFi from https://github.com/google/code-prettify -->
<script>
/* We want to add the class "prettyprint" to all the pre elements */
var pre_list = document.querySelectorAll("pre");

pre_list.forEach(function(elem) {
    elem.classList.add("prettyprint");
    elem.classList.add("linenums");/**/
    elem.classList.add("json"); /**/
});
</script>
<style>
li.L0, li.L1, li.L2, li.L3, li.L4, li.L5, li.L6, li.L7, li.L8, li.L9
{
    color: #555;
    list-style-type: decimal;
}
</style>
<link rel="stylesheet" type="text/css" href="/css/prettify.css">
<script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_
prettify.js"></script>
<!--  END: PrettyFi from https://github.com/google/code-prettify -->

</body>
</html>
